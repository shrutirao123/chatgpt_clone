
{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SSSL GPT</title>
    <link rel="stylesheet" href="{% static 'chat.css' %}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* =========================================
           INLINE STYLES (Overrides/Specifics)
           ========================================= */
        
        /* New Purple Theme Variables for Inline usage */
        :root {
            --accent-purple: #8b5cf6;
            --accent-purple-hover: #7c3aed;
            --bg-dark-secondary: #1a1a24;
            --border-color: #353545;
        }

        /* Markdown Formatting Styles */
        .message-text p { margin-bottom: 0.5em; }
        .message-text p:last-child { margin-bottom: 0; }
        .message-text ul, .message-text ol { margin-left: 1.5em; margin-bottom: 0.5em; padding-left: 5px; }
        .message-text ul { list-style-type: disc; }
        .message-text ol { list-style-type: decimal; }
        .message-text li { margin-bottom: 0.3em; }
        
        /* HEADINGS: White in Dark Mode, Black in Light Mode */
        .message-text h1, .message-text h2, .message-text h3 {
            font-weight: 300; 
            margin-top: 1em; 
            margin-bottom: 0.5em; 
            line-height: 1.3; 
            color: var(--heading-color);
        }
        .chat-app.light .message-text h1, 
        .chat-app.light .message-text h2, 
        .chat-app.light .message-text h3 {
            color: var(--lm-heading-color) !important;
        }

        /* BOLD: White in Dark Mode, Black in Light Mode */
        .message-text strong { 
            font-weight: 200; 
            color: var(--bold-color); 
        }
        .chat-app.light .message-text strong {
            color: var(--lm-bold-color) !important;
        }
        
        .message-text code {
            background: rgba(139, 92, 246, 0.15); /* Purple tint */
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 0.9em;
            color: #c4b5fd;
        }

        .message-text pre {
            background: #15151a;
            padding: 12px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid var(--border-color);
        }

        .message-text pre code {
            background: transparent;
            padding: 0;
            color: #e2e8f0;
        }

        /* Light mode Code blocks */
        .chat-app.light .message-text code { background: rgba(139, 92, 246, 0.1); color: #7c3aed; }
        .chat-app.light .message-text pre { background: #f3f4f6; border-color: #e5e7eb; }
        .chat-app.light .message-text pre code { color: #1f2937; }

        /* =========================================
           Welcome Screen Styles (Purple Theme)
           ========================================= */
        .welcome-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            padding: 40px;
            background-image: radial-gradient(circle at center, rgba(139, 92, 246, 0.05) 0%, transparent 60%);
        }

        @media (max-width: 768px) {
            .welcome-screen {
                padding: 20px;
                align-items: flex-start;
                overflow-y: auto;
            }
        }

        .welcome-container {
            max-width: 700px;
            text-align: center;
        }

        .welcome-icon {
            font-size: 80px;
            margin-bottom: 30px;
            animation: floatIcon 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.4));
        }

        @keyframes floatIcon {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .welcome-title {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #fff 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0;
            animation: fadeInDown 0.8s ease forwards;
            letter-spacing: -1px;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-message {
            font-size: 20px;
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 40px;
            min-height: 60px;
        }

        .streaming-text {
            display: inline;
            border-right: 3px solid var(--accent-purple);
            animation: blink 0.7s step-end infinite;
        }

        @keyframes blink { 50% { border-color: transparent; } }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 50px;
            opacity: 0;
            animation: fadeInUp 0.8s ease 1.5s forwards;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feature-card {
            background: rgba(26, 26, 36, 0.6);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-purple);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.15);
            background: rgba(26, 26, 36, 0.9);
        }

        .feature-icon {
            font-size: 32px;
            margin-bottom: 15px;
        }

        .feature-title {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-light);
        }

        .feature-desc {
            font-size: 14px;
            color: var(--text-medium);
            line-height: 1.5;
        }

        .start-prompt {
            margin-top: 50px;
            font-size: 15px;
            color: var(--text-medium);
            opacity: 0;
            animation: fadeIn 0.8s ease 2s forwards;
            font-weight: 500;
        }

        @keyframes fadeIn { to { opacity: 1; } }

        .pulse-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--accent-purple);
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 10px var(--accent-purple);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.4); }
        }

        /* Light mode adjustments */
        .chat-app.light .feature-card {
            background: #fff;
            border-color: #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .chat-app.light .feature-card:hover {
            border-color: var(--accent-purple);
            box-shadow: 0 10px 15px -3px rgba(139, 92, 246, 0.2);
        }
        .chat-app.light .feature-title { color: #1f2937; }
        .chat-app.light .feature-desc { color: #4b5563; }
        .chat-app.light .welcome-message { color: #374151; }
        .chat-app.light .start-prompt { color: #6b7280; }
        .chat-app.light .welcome-title {
            background: linear-gradient(135deg, #7c3aed 0%, #4c1d95 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .message-text { white-space: pre-wrap; line-height: 1.6; }
        .message.bot .message-text { white-space: normal; }
        .message-text li:empty { display: none; }
        .message-text li:empty::before { content: none; }

    </style>
</head>

<body>
    <div class="chat-app" id="chatApp">
        <div class="sidebar" id="sidebar">
            <button class="toggle-btn" id="toggleSidebar">‚ò∞</button>
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-logo">{{ request.user.username|first|upper }}</div>
                    <span class="username">{{ request.user.username }}</span>
                </div>
                <button class="new-chat-btn" id="newChatBtn">+ New Chat</button>
            </div>

            <div class="chat-history" id="chatHistory">
                {% for conv in conversations %}
                <div class="history-item {% if conversation.id == conv.id %}selected{% endif %}"
                    data-conversation-id="{{ conv.id }}" data-url="{% url 'chat_ui_conversation' conv.id %}"
                    data-title="{{ conv.title|default:'New Chat' }}">
                    <strong class="chat-title">{{ conv.title|default:"New Chat" }}</strong>
                    <button class="more-options-btn" data-id="{{ conv.id }}">‚ãÆ</button>
                </div>
                {% empty %}
                <p style="padding:10px; opacity: 0.6; font-size: 0.85rem;">No conversations yet.</p>
                {% endfor %}

                {% if archived_conversations %}
                <div class="archive-section">
                    <div class="archive-toggle" id="archiveToggle">
                        <span>üì¶ Archived</span>
                        <span class="archive-arrow">‚ñº</span>
                    </div>
                    <div class="archive-list" id="archiveList" style="display: none;">
                        {% for conv in archived_conversations %}
                        <div class="history-item archived {% if conversation.id == conv.id %}selected{% endif %}"
                            data-conversation-id="{{ conv.id }}" data-url="{% url 'chat_ui_conversation' conv.id %}"
                            data-title="{{ conv.title|default:'New Chat' }}" data-archived="true">
                            <strong class="chat-title">{{ conv.title|default:"New Chat" }}</strong>
                            <button class="more-options-btn" data-id="{{ conv.id }}">‚ãÆ</button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle-btn" id="themeToggleBtn">‚òÄÔ∏è Light Mode</button>
                <form method="POST" action="{% url 'logout' %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn">üö™ Logout</button>
                </form>
            </div>
        </div>

        <div class="context-dropdown" id="contextDropdown" style="display: none;">
            <div class="dropdown-item" id="renameOption">
                <span>‚úèÔ∏è</span>
                <span>Rename</span>
            </div>
            <div class="dropdown-item" id="archiveOption">
                <span id="archiveIcon">üì¶</span>
                <span id="archiveText">Archive</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item danger" id="deleteOption">
                <span>üóëÔ∏è</span>
                <span>Delete</span>
            </div>
        </div>

        <div id="renameModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>Rename Conversation</h3>
                <input type="text" id="renameInput" placeholder="Enter new title..." maxlength="100">
                <div class="modal-actions">
                    <button class="btn-cancel" id="cancelRename">Cancel</button>
                    <button class="btn-save" id="confirmRename">Save</button>
                </div>
            </div>
        </div>

        <div id="editMessageModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>Edit Message</h3>
                <textarea id="editMessageInput" placeholder="Edit your message..."
                    style="width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-light); margin-bottom: 16px; font-size: 14px; outline: none; min-height: 120px; font-family: inherit; resize: vertical;"></textarea>
                <div class="modal-actions">
                    <button class="btn-cancel" id="cancelEditMessage">Cancel</button>
                    <button class="btn-save" id="confirmEditMessage">Save & Resend</button>
                </div>
            </div>
        </div>

        <div class="main-chat">
            <div class="messages-container" id="messagesContainer">
                {% for msg in messages %}
                <div class="message {{ msg.sender }}">
                    <div class="avatar">
                        {% if msg.sender == "user" %}
                        {{ request.user.username|slice:":1"|upper }}
                        {% elif msg.sender == "system" %}
                        ‚ÑπÔ∏è
                        {% else %}
                        A
                        {% endif %}
                    </div>

                    <div class="message-body">
                        <div class="message-role">
                            {% if msg.sender == "user" %}You{% elif msg.sender == "system" %}System{% else
                            %}Assistant{%endif %}
                        </div>
                        {% if msg.sender == "bot" %}
                        <div class="message-text" data-markdown="{{ msg.content }}"></div>
                        {% else %}
                        <div class="message-text">{{ msg.content }}</div>
                        {% endif %}

                    </div>
                </div>
                {% empty %}
                <div class="welcome-screen">
                    <div class="welcome-container">
                        <div class="welcome-icon">ü§ñ</div>
                        <h1 class="welcome-title">Welcome to SSSL GPT!</h1>

                        <div class="welcome-message">
                            <span class="streaming-text" id="streamingText"></span>
                        </div>

                        <div class="features">
                            <div class="feature-card">
                                <div class="feature-icon">üí¨</div>
                                <div class="feature-title">Natural Conversations</div>
                                <div class="feature-desc">Chat naturally and get intelligent responses</div>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">üé®</div>
                                <div class="feature-title">Creative Assistance</div>
                                <div class="feature-desc">Generate ideas, content, and solutions</div>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon">‚ö°</div>
                                <div class="feature-title">Fast & Reliable</div>
                                <div class="feature-desc">Quick responses powered by advanced AI</div>
                            </div>
                        </div>

                        <div class="start-prompt">
                            Type a message below to begin<span class="pulse-dot"></span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <button id="jumpBottomBtn">
                ‚Üì
            </button>

            <div id="imagePreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
                <div style="position: relative; max-width: 90%; max-height: 90%;">
                    <img id="previewImage" style="max-width: 100%; max-height: 90vh; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                    <button id="closePreview"
                        style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white;
                        border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; width: 36px; height: 36px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center;">√ó</button>
                </div>
            </div>

            <div class="input-area">
                <div id="imagePreviewContainer"
                    style="display: none; padding: 12px; background: rgba(26, 26, 36, 0.95); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                    <img id="selectedImagePreview" style="max-width: 120px; max-height: 120px; border-radius: 8px;">
                    <button id="removeImageBtn"
                        style="margin-left: 12px; padding: 6px 12px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">Remove</button>
                </div>

                <form id="chatForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="conversation_id" value="{{ conversation.id }}">
                    <label class="file-upload">
                        <span style="font-size: 1.2rem; color: var(--text-medium);">üìéUPLOAD Files </span> 
                        <span id="fileNameDisplay" style="margin-left: 8px; font-size: 0.9rem; color: var(--text-medium); display: none;">Upload File</span>
                        <input type="file" id="fileInput"
                            accept=".pdf, .png, .jpg, .jpeg, .gif, .webp, .bmp, .xls, .xlsx, .docx, .doc, .csv, .pptx"
                            name="file">
                        <span class="file-clear-btn" id="fileClearBtn"
                            style="display: none; margin-left: 10px; color: #ff4444; font-weight: bold;">√ó</span>
                    </label>
                    <input type="text" id="messageInput" placeholder="Type a message..." name="message">
                    <button type="submit" id="sendBtn">Send</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const chatApp = document.getElementById("chatApp");
        const messagesContainer = document.getElementById("messagesContainer");
        const messageInput = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");
        const fileInput = document.getElementById("fileInput");
        const fileNameDisplay = document.getElementById("fileNameDisplay");
        const newChatBtn = document.getElementById("newChatBtn");
        const sidebar = document.getElementById("sidebar");
        const themeToggleBtn = document.getElementById("themeToggleBtn");
        const chatHistory = document.getElementById("chatHistory");
        const chatForm = document.getElementById("chatForm");
        const jumpBtn = document.getElementById("jumpBottomBtn");
        const fileClearBtn = document.getElementById("fileClearBtn");
        const imagePreviewContainer = document.getElementById("imagePreviewContainer");
        const selectedImagePreview = document.getElementById("selectedImagePreview");
        const removeImageBtn = document.getElementById("removeImageBtn");
        const imagePreviewModal = document.getElementById("imagePreviewModal");
        const previewImage = document.getElementById("previewImage");
        const closePreview = document.getElementById("closePreview");
        const renameModal = document.getElementById("renameModal");
        const renameInput = document.getElementById("renameInput");
        const confirmRename = document.getElementById("confirmRename");
        const cancelRename = document.getElementById("cancelRename");
        const contextDropdown = document.getElementById("contextDropdown");
        const archiveToggle = document.getElementById("archiveToggle");
        const archiveList = document.getElementById("archiveList");
        const editMessageModal = document.getElementById("editMessageModal");
        const editMessageInput = document.getElementById("editMessageInput");
        const confirmEditMessage = document.getElementById("confirmEditMessage");
        const cancelEditMessage = document.getElementById("cancelEditMessage");

        let isSending = false;
        let stopStream = false;
        let currentContextConvId = null;
        let currentContextIsArchived = false;
        let currentEditingMessageElement = null;

        (function parseExistingMessages() {
            document.querySelectorAll('.message.bot .message-text').forEach(el => {
                const rawText = el.getAttribute('data-markdown');
                if (rawText && rawText.trim()) {
                    try {
                        const cleanMarkdown = preprocessMarkdown(rawText);
                        el.innerHTML = marked.parse(cleanMarkdown); 
                        el.style.whiteSpace = 'normal';
                    } catch (e) {
                        console.error("Error parsing existing message:", e);
                    }
                }
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        })();
        const streamingTextElement = document.getElementById('streamingText');
        if (streamingTextElement) {
            const messages = [
                "I'm here to help you with anything you need.",
                "Ask me questions, get creative ideas, or solve problems together.",
                "Let's start an amazing conversation!"
            ];

            let messageIndex = 0;
            let charIndex = 0;
            let currentMessage = '';

            function typeMessage() {
                if (messageIndex < messages.length) {
                    if (charIndex < messages[messageIndex].length) {
                        currentMessage += messages[messageIndex][charIndex];
                        streamingTextElement.textContent = currentMessage;
                        charIndex++;
                        setTimeout(typeMessage, 30);
                    } else {
                        messageIndex++;
                        if (messageIndex < messages.length) {
                            currentMessage += ' ';
                            charIndex = 0;
                            setTimeout(typeMessage, 200);
                        } else {
                            streamingTextElement.style.borderRight = 'none';
                        }
                    }
                }
            }

            setTimeout(typeMessage, 800);
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('chatTheme') || 'dark';
            if (savedTheme === 'light') {
                chatApp.classList.add('light');
                themeToggleBtn.innerHTML = "üåô Dark Mode";
            } else {
                chatApp.classList.remove('light');
                themeToggleBtn.innerHTML = "‚òÄÔ∏è Light Mode";
            }
        }

        themeToggleBtn.addEventListener("click", () => {
            chatApp.classList.toggle("light");
            const isLight = chatApp.classList.contains("light");
            themeToggleBtn.innerHTML = isLight ? "üåô Dark Mode" : "‚òÄÔ∏è Light Mode";
            localStorage.setItem('chatTheme', isLight ? 'light' : 'dark');
        });

        initializeTheme();

        if (archiveToggle) {
            archiveToggle.addEventListener("click", () => {
                const isHidden = archiveList.style.display === "none";
                archiveList.style.display = isHidden ? "block" : "none";
                archiveToggle.querySelector(".archive-arrow").textContent = isHidden ? "‚ñ≤" : "‚ñº";
            });
        }

        function setupContextMenus() {
            document.querySelectorAll(".more-options-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const convId = btn.dataset.id;
                    const historyItem = btn.closest(".history-item");
                    currentContextConvId = convId;
                    currentContextIsArchived = historyItem.dataset.archived === "true";

                    document.getElementById("archiveIcon").textContent = currentContextIsArchived ? "üì§" : "üì¶";
                    document.getElementById("archiveText").textContent = currentContextIsArchived ? "Unarchive" : "Archive";

                    contextDropdown.style.display = "block";

                    const btnRect = btn.getBoundingClientRect();
                    const dropdownRect = contextDropdown.getBoundingClientRect();
                    let left = btnRect.left - dropdownRect.width - 8;
                    let top = btnRect.top;

                    if (left < 10) left = btnRect.right + 8;
                    if (left + dropdownRect.width > window.innerWidth - 10) left = window.innerWidth - dropdownRect.width - 10;
                    if (top + dropdownRect.height > window.innerHeight - 10) top = btnRect.bottom - dropdownRect.height;
                    if (top < 10) top = 10;

                    contextDropdown.style.left = `${left}px`;
                    contextDropdown.style.top = `${top}px`;
                });
            });
        }

        setupContextMenus();

        document.addEventListener("click", (e) => {
            if (!contextDropdown.contains(e.target) && !e.target.classList.contains("more-options-btn")) {
                contextDropdown.style.display = "none";
            }
        });

        renameOption.addEventListener("click", () => {
            contextDropdown.style.display = "none";
            const historyItem = document.querySelector(`.history-item[data-conversation-id="${currentContextConvId}"]`);
            renameInput.value = historyItem.dataset.title;
            renameModal.style.display = "flex";
            renameInput.focus();
        });

        cancelRename.addEventListener("click", () => renameModal.style.display = "none");
        renameModal.addEventListener("click", (e) => { if (e.target === renameModal) renameModal.style.display = "none"; });

        confirmRename.addEventListener("click", async () => {
            const newTitle = renameInput.value.trim();
            if (!newTitle) { alert("Title cannot be empty"); return; }
            try {
                const res = await fetch(`/api/rename_conversation/${currentContextConvId}/`, {
                    method: "POST",
                    headers: { "X-CSRFToken": getCSRFToken(), "Content-Type": "application/json" },
                    body: JSON.stringify({ title: newTitle })
                });
                const data = await res.json();
                if (data.success) {
                    const historyItem = document.querySelector(`.history-item[data-conversation-id="${currentContextConvId}"]`);
                    historyItem.querySelector(".chat-title").textContent = data.title;
                    historyItem.dataset.title = data.title;
                    renameModal.style.display = "none";
                } else {
                    alert("Failed to rename: " + (data.error || "Unknown error"));
                }
            } catch (err) { console.error("Rename error:", err); alert("Error renaming conversation"); }
        });

        archiveOption.addEventListener("click", async () => {
            contextDropdown.style.display = "none";
            const msg = currentContextIsArchived ? "Unarchive this chat?" : "Archive this chat?";
            if (!confirm(msg)) return;
            try {
                const res = await fetch(`/api/toggle_archive_conversation/${currentContextConvId}/`, {
                    method: "POST",
                    headers: { "X-CSRFToken": getCSRFToken() }
                });
                const data = await res.json();
                if (data.success) window.location.reload();
                else alert("Failed: " + (data.error || "Unknown error"));
            } catch (err) { console.error("Archive error:", err); }
        });

        deleteOption.addEventListener("click", async () => {
            contextDropdown.style.display = "none";
            if (!confirm("Delete this chat?")) return;
            try {
                const res = await fetch(`/api/delete_conversation/${currentContextConvId}/`, {
                    method: "DELETE",
                    headers: { "X-CSRFToken": getCSRFToken() }
                });
                const data = await res.json();
                if (data.success) {
                    document.querySelector(`.history-item[data-conversation-id="${currentContextConvId}"]`).remove();
                    if (window.location.href.includes(currentContextConvId)) window.location.href = "/";
                } else {
                    alert("Failed: " + data.error);
                }
            } catch (err) { console.error("Delete error:", err); }
        });

        function getCSRFToken() {
            const tokenElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (tokenElement) return tokenElement.value;
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) return decodeURIComponent(cookie.substring('csrftoken='.length));
            }
            return null;
        }

        function isImageFile(filename) {
            return ['.png', '.jpg', '.jpeg', '.gif', '.bmp', '.webp'].some(ext => filename.toLowerCase().endsWith(ext));
        }

        function updateFileDisplay() {
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileNameDisplay.textContent = file.name.length > 15 ? file.name.slice(0, 12) + '...' : file.name;
                fileNameDisplay.style.display = "inline"; // Show file name
                fileClearBtn.style.display = 'inline';
                if (isImageFile(file.name)) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        selectedImagePreview.src = e.target.result;
                        imagePreviewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreviewContainer.style.display = 'none';
                }
            } else {
                fileNameDisplay.textContent = "Upload File";
                fileNameDisplay.style.display = "none";
                fileClearBtn.style.display = 'none';
                imagePreviewContainer.style.display = 'none';
            }
        }

        fileInput.addEventListener('change', updateFileDisplay);
        fileClearBtn.addEventListener('click', (e) => { e.preventDefault(); fileInput.value = ""; updateFileDisplay(); });
        removeImageBtn.addEventListener('click', () => { fileInput.value = ""; updateFileDisplay(); });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

function preprocessMarkdown(text) {
            if (!text) return "";

            let fixed = text;

            fixed = fixed.replace(/^\*([A-Z][^\n]+)$/gm, "**$1**");
            fixed = fixed.replace(/\n\*([A-Z][^\n]+)/g, "\n\n**$1**");
            fixed = fixed.replace(/^\s*[-]\s$/gm, "");
            fixed = fixed.replace(/\n{3,}/g, "\n\n");

            // SAFE: spacing before ordered & unordered list items
            fixed = fixed.replace(/([^\n])\n(\s*(?:[-*]|\d+\.)\s)/g, "$1\n\n$2");

            // SAFE HEADING SPACING
            fixed = fixed.replace(/([^\n])(\s*#{1,6}\s)/g, "$1\n\n$2");

            // // CODE BLOCK FIXES
            // fixed = fixed.replace(/([^\n])()/g, "$1\n\n$2");
            // fixed = fixed.replace(/()([^\n])/g, "$1\n\n$2");

            // Convert any # heading ‚Üí ####
            fixed = fixed.replace(/^\s*#{1,6}\s*(.+)$/gm, "#### $1");

            return fixed;
        }
        function appendMessage(role, text, isLoading = false, isHtml = false) {
            const welcomeScreen = messagesContainer.querySelector(".welcome-screen");
            if (welcomeScreen) welcomeScreen.remove();

            const div = document.createElement("div");
            div.className = `message ${role}`;

            let content = "";
            if (role === "user" && !isHtml) {
                content = escapeHtml(text);
            } else if (role === "user" && isHtml) {
                content = text; 
            } else if (role === "bot" && text) {
                content = escapeHtml(text);
            }

            const whiteSpaceStyle = role === 'bot' ? 'normal' : 'pre-wrap';

            div.innerHTML = `
                <div class="avatar">${role === "user" ? "{{ request.user.username|first|upper }}" : "AI"}</div>
                <div class="message-body">
                    <div class="message-role">${role === "user" ? "You" : "Assistant"}</div>
                    <div class="message-text" style="white-space: ${whiteSpaceStyle};">${content}${isLoading && role === "bot" ? `
                        <span class="typing"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span>
                    ` : ""}</div>
                </div>
            `;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return div;
        }

        document.getElementById("toggleSidebar").addEventListener("click", () => sidebar.classList.toggle("collapsed"));
        newChatBtn.addEventListener("click", async () => {
            if (isSending) return;
            try {
                const res = await fetch("/api/new_conversation/", {
                    method: "POST",
                    headers: { "X-CSRFToken": getCSRFToken(), "Content-Type": "application/json" },
                    body: JSON.stringify({})
                });
                const data = await res.json();
                window.location.href = `/conversation/${data.conversation_id}/`;
            } catch (err) { alert("Failed to create new chat."); }
        });

        chatHistory.querySelectorAll(".history-item").forEach(item => {
            item.addEventListener("click", (e) => {
                if (!e.target.classList.contains("more-options-btn")) window.location.href = item.dataset.url;
            });
        });

        chatForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            const file = fileInput.files[0];
            const conversationId = document.querySelector('input[name="conversation_id"]').value;

            if (isSending) {
                stopStream = true;
                sendBtn.disabled = true;
                sendBtn.textContent = "Stopping...";
                try { await fetch("/api/stream_chat_with_ai/", { method: "POST", headers: { 'X-CSRFToken': getCSRFToken() }, body: new URLSearchParams({ conversation_id: conversationId, stop: "true" }) }); } catch (err) { }
                return;
            }

            if (!text && !file) return;

            isSending = true;
            stopStream = false;
            sendBtn.textContent = "Stop";
            sendBtn.disabled = false;

            if (file && isImageFile(file.name)) {
                await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imgHtml = `<img src="${e.target.result}" alt="uploaded image" style="max-width:300px; border-radius:8px; margin-bottom:8px;"><br>üì∑ <strong>${file.name}</strong><br>${text || "Describe this image."}`;
                        appendMessage("user", imgHtml, false, true);
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            } else if (file) {
                appendMessage("user", `üìÑ <strong>Uploaded: ${file.name}</strong><br>${text || "Process this file."}`, false, true);
            } else {
                appendMessage("user", text);
            }

            const aiMessageDiv = appendMessage("bot", "", true);
            const aiText = aiMessageDiv.querySelector(".message-text");

            const formData = new FormData();
            formData.append('message', text);
            formData.append('conversation_id', conversationId);
            if (file) formData.append('file', file);

            messageInput.value = "";
            fileInput.value = "";
            updateFileDisplay();

            try {
                const response = await fetch("/api/stream_chat_with_ai/", {
                    method: "POST",
                    headers: { 'X-CSRFToken': getCSRFToken() },
                    body: formData
                });

                if (!response.ok) throw new Error("Network error");

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let accumulatedText = "";

                while (true) {
                    if (stopStream) { reader.cancel(); break; }
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        let token = line.replace('data: ', '');
                        if (token === '[STOPPED]') { stopStream = true; break; }

                        accumulatedText += token.replace(/\\n/g, "\n");

                        try {
                            const typingEl = aiText.querySelector('.typing');
                            if (typingEl) typingEl.remove();

                            const cleanMarkdown = preprocessMarkdown(accumulatedText);
                            aiText.innerHTML = marked.parse(cleanMarkdown);
                            aiText.style.whiteSpace = 'normal';

                            if (!stopStream) {
                                const typingSpan = document.createElement('span');
                                typingSpan.className = 'typing';
                                typingSpan.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
                                aiText.appendChild(typingSpan);
                            }

                            aiText.style.whiteSpace = 'normal';
                        } catch (err) {
                            aiText.textContent = accumulatedText;
                        }

                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }
            } catch (err) {
                aiText.innerHTML = accumulatedText || "‚ö†Ô∏è Error retrieving response.";
            } finally {
                isSending = false;
                stopStream = false;
                sendBtn.disabled = false;
                sendBtn.textContent = "Send";
                if (aiText.querySelector('.typing')) aiText.querySelector('.typing').remove();
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });

        function addCopyButtons() {
            document.querySelectorAll(".message").forEach(msg => {
                if (msg.querySelector(".message-actions")) return;
                const isUserMessage = msg.classList.contains("user");
                const actionsDiv = document.createElement("div");
                actionsDiv.className = "message-actions";

                const copyBtn = document.createElement("button");
                copyBtn.innerHTML = "üìã";
                copyBtn.className = "copy-msg-btn";
                copyBtn.addEventListener("click", async () => {
                    const txt = msg.querySelector(".message-text")?.innerText || "";
                    try {
                        await navigator.clipboard.writeText(txt);
                        copyBtn.innerHTML = "‚úÖ";
                        setTimeout(() => (copyBtn.innerHTML = "üìã"), 1200);
                    } catch (err) {
                        console.error("Clipboard error:", err);
                        const textarea = document.createElement("textarea");
                        textarea.value = txt;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand("copy");
                        textarea.remove();
                        copyBtn.innerHTML = "‚úÖ";
                        setTimeout(() => (copyBtn.innerHTML = "üìã"), 1200);
                    }
                });

                actionsDiv.appendChild(copyBtn);

                if (isUserMessage) {
                    const editBtn = document.createElement("button");
                    editBtn.innerHTML = "‚úèÔ∏è";
                    editBtn.className = "edit-msg-btn";
                    editBtn.addEventListener("click", () => {
                        currentEditingMessageElement = msg;
                        editMessageInput.value = msg.querySelector(".message-text").innerText.trim();
                        editMessageModal.style.display = "flex";
                    });
                    actionsDiv.appendChild(editBtn);
                }
                msg.appendChild(actionsDiv);
            });
        }

        addCopyButtons();
        new MutationObserver(() => addCopyButtons()).observe(messagesContainer, { childList: true, subtree: true });

        cancelEditMessage.addEventListener("click", () => { editMessageModal.style.display = "none"; currentEditingMessageElement = null; });
        editMessageModal.addEventListener("click", (e) => { if (e.target === editMessageModal) { editMessageModal.style.display = "none"; currentEditingMessageElement = null; } });

        confirmEditMessage.addEventListener("click", async () => {
            const newText = editMessageInput.value.trim();
            if (!newText) return;
            editMessageModal.style.display = "none";
            if (!currentEditingMessageElement) return;

            let next = currentEditingMessageElement.nextElementSibling;
            while (next) { const rm = next; next = next.nextElementSibling; rm.remove(); }

            currentEditingMessageElement.querySelector(".message-text").textContent = newText;
            currentEditingMessageElement = null;

            messageInput.value = newText;
            sendBtn.click();
        });

        function updateJumpButtonVisibility() {
            const distanceToBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight;
            if (distanceToBottom > 100) {
                jumpBtn.style.display = "flex";
            } else {
                jumpBtn.style.display = "none";
            }
        }
        
        messagesContainer.addEventListener("scroll", updateJumpButtonVisibility);

        jumpBtn.addEventListener("click", () => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
        
        function autoScrollOnNewMessage() {
            const distanceToBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight;
            if (distanceToBottom < 150) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else {
                jumpBtn.style.display = "flex";
            }
        }

        const observer = new MutationObserver(autoScrollOnNewMessage);
        observer.observe(messagesContainer, { childList: true, subtree: true });
    </script>
</body>

</html>
